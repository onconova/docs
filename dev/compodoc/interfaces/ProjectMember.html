<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>Application documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
        <link rel="stylesheet" href="../styles/material.css">
    </head>
    <body>
          <script>
               // Blocking script to avoid flickering dark mode
               // Dark mode toggle button
               var useDark = window.matchMedia('(prefers-color-scheme: dark)');
               var darkModeState = useDark.matches;
               var $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               var $darkModeToggles = document.querySelectorAll('.dark-mode-switch');
               var darkModeStateLocal = localStorage.getItem('compodoc_darkmode-state');

               function checkToggle(check) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].checked = check;
                    }
               }

               function toggleDarkMode(state) {
                    if (window.localStorage) {
                         localStorage.setItem('compodoc_darkmode-state', state);
                    }

                    checkToggle(state);

                    const hasClass = document.body.classList.contains('dark');

                    if (state) {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.add('dark');
                         }
                         if (!hasClass) {
                              document.body.classList.add('dark');
                         }
                    } else {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.remove('dark');
                         }
                         if (hasClass) {
                              document.body.classList.remove('dark');
                         }
                    }
               }

               useDark.addEventListener('change', function (evt) {
                    toggleDarkMode(evt.matches);
               });
               if (darkModeStateLocal) {
                    darkModeState = darkModeStateLocal === 'true';
               }
               toggleDarkMode(darkModeState);
          </script>

        <div class="navbar navbar-default navbar-fixed-top d-md-none p-0">
               <div class="d-flex">
                    <a href="../" class="navbar-brand">Application documentation</a>
                    <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
               </div>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="d-none d-md-block menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content interface">
                   <div class="content-data">













<ol class="breadcrumb">
  <li class="breadcrumb-item">Interfaces</li>
  <li class="breadcrumb-item"
  >
  ProjectMember</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a href="#info" 
                class="nav-link"
                class="nav-link active"
                role="tab" id="info-tab" data-bs-toggle="tab" data-link="info">Info</a>
        </li>
        <li class="nav-item">
            <a href="#source" 
                class="nav-link"
                
                role="tab" id="source-tab" data-bs-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>/home/runner/work/onconova/onconova/client/src/app/features/project-management/project-management.component.ts</code>
        </p>



            <p class="comment">
                <h3>Extends</h3>
            </p>
            <p class="comment">
                        <code>User</code>
            </p>

        <section data-compodoc="block-index">
            <h3 id="index">Index</h3>
            <table class="table table-sm table-bordered index-table">
                <tbody>
                    <tr>
                        <td class="col-md-4">
                            <h6><b>Properties</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                        <a href="#authorization" 
>
                                            authorization
                                        </a>
                                </li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>



            <section data-compodoc="block-properties">
                <h3 id="inputs">Properties</h3>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="authorization"></a>
                                        <span class="name "><b>authorization</b>
                                            <a href="#authorization">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>authorization:     <code>ProjectDataManagerGrant</code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code>ProjectDataManagerGrant</code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
            </section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { CommonModule } from &quot;@angular/common&quot;;
import { Component, computed, inject, input, signal } from &quot;@angular/core&quot;;
import { rxResource } from &quot;@angular/core/rxjs-interop&quot;;
import { FormsModule } from &quot;@angular/forms&quot;;
import { ConfirmationService, MenuItem, MessageService } from &quot;primeng/api&quot;;
import { Button } from &quot;primeng/button&quot;;
import { ConfirmDialog } from &quot;primeng/confirmdialog&quot;;
import { DataView } from &quot;primeng/dataview&quot;;
import { DatePicker } from &quot;primeng/datepicker&quot;;
import { Fluid } from &quot;primeng/fluid&quot;;
import { Menu } from &quot;primeng/menu&quot;;
import { Skeleton } from &quot;primeng/skeleton&quot;;
import { TableModule } from &quot;primeng/table&quot;;
import { TagModule } from &quot;primeng/tag&quot;;
import { ToggleSwitch } from &quot;primeng/toggleswitch&quot;;
import { BehaviorSubject, forkJoin, from, map, mergeMap, Observable, toArray } from &quot;rxjs&quot;;
import { UserBadgeComponent } from &quot;src/app/shared/components/user-badge/user-badge.component&quot;;
import { AccessRoles, Cohort, CohortsService, DatasetsService, Period, ProjectCreate, ProjectDataManagerGrant, ProjectsService, ProjectStatusChoices, User, UsersService } from &quot;onconova-api-client&quot;;
import { CohortSearchItemComponent } from &quot;../cohorts/cohort-search/components/cohort-search-item/cohort-search-item.component&quot;;
import { AuthService } from &quot;src/app/core/auth/services/auth.service&quot;;
import { ResolveResourcePipe } from &quot;src/app/shared/pipes/resolve-resource.pipe&quot;;
import { Popover } from &quot;primeng/popover&quot;;
import { UserSelectorComponent } from &quot;src/app/shared/components/user-selector/user-selector.component&quot;;
import { Divider } from &quot;primeng/divider&quot;;
import { Card } from &quot;primeng/card&quot;;

interface ProjectMember extends User {
    authorization: ProjectDataManagerGrant
}

@Component({
    selector: &#x27;onconova-project-management&#x27;,
    templateUrl: &#x27;./project-management.component.html&#x27;,
    providers: [
        ConfirmationService
    ],
    imports: [
        Fluid,
        FormsModule,
        CommonModule,
        Skeleton,
        UserBadgeComponent,
        Divider,
        Popover,
        Card,
        ConfirmDialog,
        ToggleSwitch,
        TagModule,
        DataView,
        TableModule,
        DatePicker,
        Menu,
        Button,
        UserSelectorComponent,
        CohortSearchItemComponent,
    ]
})
export class ProjectManagementComponent {
    
    readonly projectId &#x3D; input.required&lt;string&gt;();
    
    readonly #projectsService &#x3D; inject(ProjectsService);
    readonly #userService &#x3D; inject(UsersService);
    readonly #authService &#x3D; inject(AuthService);
    readonly #messageService &#x3D; inject(MessageService);
    readonly #confirmationService &#x3D; inject(ConfirmationService);
    readonly #cohortsService &#x3D; inject(CohortsService);
    readonly #datasetsService &#x3D; inject(DatasetsService);

    public readonly currentUser &#x3D; computed(() &#x3D;&gt; this.#authService.user())

    protected project &#x3D; rxResource({
        request: () &#x3D;&gt; ({projectId: this.projectId()}),
        loader: ({request}) &#x3D;&gt; this.#projectsService.getProjectById(request)
    });
    
    protected readonly membersPlaceholder &#x3D; [1,3,4,5] as unknown as ProjectMember[];
    protected members &#x3D; rxResource({
        request: () &#x3D;&gt; ({usernameAnyOf: this.project.value()?.members ?? []}),
        loader: ({request}) &#x3D;&gt; this.#userService.getUsers(request).pipe(
            map(response &#x3D;&gt; response.items),       
            mergeMap(users &#x3D;&gt; from(users)),
            mergeMap((user): Observable&lt;ProjectMember&gt; &#x3D;&gt;
                forkJoin({
                authorization: this.#projectsService.getProjectDataManagerGrant({projectId: this.projectId(), memberId: user.id}).pipe(map(response &#x3D;&gt; response.items[0])),
                }).pipe(
                map(results &#x3D;&gt; ({
                    ...user,
                    ...results
                }))
                )
            ),
            toArray()
        )
    });

    protected cohorts &#x3D; rxResource({
        request: () &#x3D;&gt; ({projectId: this.projectId()}),
        loader: ({request}) &#x3D;&gt; this.#cohortsService.getCohorts(request).pipe(map(response &#x3D;&gt; {
            this.totalCohorts.set(response.count)
            return response.items
        }))
    });
    protected datasets &#x3D; rxResource({
        request: () &#x3D;&gt; ({projectId: this.projectId()}),
        loader: ({request}) &#x3D;&gt; this.#datasetsService.getDatasets(request).pipe(map(response &#x3D;&gt; {
            this.totalDatasets.set(response.count)
            return response.items
        }))
    });

    protected authDialogMember &#x3D; signal&lt;ProjectMember | null&gt;(null);
    protected authDialogConfirmation &#x3D; signal&lt;boolean&gt;(false);
    protected authDialogValidityPeriod &#x3D; signal&lt;Date[]&gt;([]);
    protected authDialogExpirationMinDate &#x3D; new Date();
    protected authDialogExpirationMaxDate &#x3D; computed(() &#x3D;&gt; {
        const start &#x3D; this.authDialogValidityPeriod()![0];
        if (!start) {
            return null
        }
        return new Date(start.getTime() + 31 * 24 * 60 * 60 * 1000)
    })
    


    // Pagination and search settings
    public readonly cohortsPageSizeChoices: number[] &#x3D; [4, 8, 12];
    public cohortsPagination &#x3D; signal({limit: this.cohortsPageSizeChoices[0], offset: 0});
    public totalCohorts&#x3D; signal(0);
    public readonly datasetsPageSizeChoices: number[] &#x3D; [4, 8, 12];
    public datasetsPagination &#x3D; signal({limit: this.cohortsPageSizeChoices[0], offset: 0});
    public totalDatasets&#x3D; signal(0);

    public selectedUser &#x3D; signal&lt;string&gt;(&#x27;&#x27;)


    getValidityPeriodAnnotation(period: Period) {
        const today &#x3D; new Date()
        const begin &#x3D; new Date(period.start!)
        const expiration &#x3D; new Date(period.end!)
        if (today &lt; begin) {
            return &#x60;Begins in ${this.getDaysDifference(today, begin)} day(s)&#x60;
        } else if (today &lt; expiration) {
            return &#x60;Expires in ${this.getDaysDifference(today, expiration)} day(s)&#x60;
        } else {
            return &#x27;Expired&#x27;
        }
    }


    matchCohort(cohortId: string) {
        return (cohort: Cohort): boolean &#x3D;&gt; cohort.id &#x3D;&#x3D; cohortId
    }
    
    getDaysDifference(start: Date, end: Date) {
        const oneDayMs &#x3D; 1000 * 60 * 60 * 24; // milliseconds in one day
        const diffMs &#x3D; end.getTime() - start.getTime();
        return Math.ceil(diffMs / oneDayMs);
    }

    canEditAuthorizations &#x3D; computed(() &#x3D;&gt; 
        this.project.value() &amp;&amp; (this.currentUser()?.accessLevel || 0) &gt; 1 &amp;&amp; (
            (this.currentUser()?.accessLevel || 0) &gt; 2 ||
            this.currentUser().username &#x3D;&#x3D; this.project.value()?.leader 
            || 
            (this.project.value()?.members || []).includes(this.currentUser().username)
         ) &amp;&amp; !(
            this.project.value()?.status &#x3D;&#x3D;&#x3D; ProjectStatusChoices.Completed 
            || this.project.value()?.status &#x3D;&#x3D;&#x3D; ProjectStatusChoices.Aborted
        ) 
    )

    public dynamicMenuItems$: BehaviorSubject&lt;MenuItem[]&gt; &#x3D; new BehaviorSubject(
        [] as MenuItem[]
    );
    getMemberMenuItems(member: ProjectMember) {
        this.dynamicMenuItems$.next([{
            label: &#x27;Actions for &#x27; + member.fullName,
            items: [
                {
                    label: &#x27;Grant data management authorization&#x27;,
                    icon: &#x27;pi pi-plus&#x27;,
                    disabled: !this.canEditAuthorizations() 
                            || (member?.accessLevel || 0) &gt;&#x3D; 2 
                            || !!member.authorization,
                    command: (event: any) &#x3D;&gt; this.grantNewAuthorization(event, member)
                },
                {
                    label: &#x27;Revoke data management authorization&#x27;,
                    disabled: !this.canEditAuthorizations() 
                            || (member?.accessLevel || 0) &gt;&#x3D; 2 
                            || !member.authorization 
                            || (new Date(member.authorization.validityPeriod.end as string) &lt; new Date()),
                    icon: &#x27;pi pi-times&#x27;,
                    command: (event: any) &#x3D;&gt; this.revokeAuthorization(event, member)
                },
                {
                    label: &#x27;Remove member&#x27;,
                    disabled: !this.canEditAuthorizations() || this.currentUser().username &#x3D;&#x3D; member.username || this.project.value()?.leader &#x3D;&#x3D; member.username,
                    icon: &#x27;pi pi-trash&#x27;,
                    command: (event: any) &#x3D;&gt; this.confirmMemberRemoval(event, member)
                },
            ]
        }])
    };

    parseStatus(status: ProjectStatusChoices): {value: string, icon: string, severity: string} {
        switch (status) {
            case ProjectStatusChoices.Planned:
                return {value: &#x27;Planned&#x27;, icon: &#x27;pi pi-info&#x27;, severity: &#x27;secondary&#x27;}
            case ProjectStatusChoices.Ongoing:
                return {value: &#x27;Ongoing&#x27;, icon: &#x27;pi pi-info&#x27;, severity: &#x27;info&#x27;}
            case ProjectStatusChoices.Completed:
                return {value: &#x27;Completed&#x27;, icon: &#x27;pi pi-check&#x27;, severity: &#x27;success&#x27;}
            case ProjectStatusChoices.Aborted:
                return {value: &#x27;Aborted&#x27;, icon: &#x27;pi pi-times&#x27;, severity: &#x27;danger&#x27;}
            default: 
                throw new Error(&#x60;Unknown status: ${status}&#x60;);
        }
    };

    grantNewAuthorization(event: Event, member: ProjectMember) {
        this.authDialogMember.set(member)
        this.authDialogValidityPeriod.set([])
        this.authDialogConfirmation.set(false)
        this.#confirmationService.confirm({
            target: event.target as EventTarget,
            closable: true,
            key: &#x27;authorize&#x27;,
            closeOnEscape: true,
            accept: () &#x3D;&gt; {
                this.#projectsService.createProjectDataManagerGrant({
                    projectId: this.projectId(),
                    memberId: member.id,
                    projectDataManagerGrantCreate: {
                        validityPeriod: {
                            start: this.authDialogValidityPeriod()[0].toISOString().split(&#x27;T&#x27;)[0],
                            end: this.authDialogValidityPeriod()[1].toISOString().split(&#x27;T&#x27;)[0],
                        }
                    }
                }).subscribe({
                    complete: () &#x3D;&gt; {
                        this.#messageService.add({ severity: &#x27;success&#x27;, summary: &#x27;Authorization&#x27;, detail: &#x27;Successfully updated authorization for &#x27; + member.fullName });
                        this.project.reload()    
                    }
                })
                
            },
            reject: () &#x3D;&gt; {},
        });
    };

    
    revokeAuthorization(event: Event, member: ProjectMember) {
        this.#confirmationService.confirm({
            target: event.target as EventTarget,
            key: &#x27;revoke&#x27;,
            closable: true,
            message: &#x60;Do you want to revoke ${member.fullName} data management authorization?&#x60;,
            icon: &#x27;pi pi-info-circle&#x27;,
            rejectButtonProps: {
                label: &#x27;Cancel&#x27;,
                severity: &#x27;secondary&#x27;,
                outlined: true
            },
            acceptButtonProps: {
                label: &#x27;Delete&#x27;,
                severity: &#x27;danger&#x27;
            },
            accept: () &#x3D;&gt; this.#projectsService.revokeProjectDataManagerGrant({
                    projectId: this.projectId(),
                    memberId: member.id,
                    grantId: member.authorization.id
                }).subscribe({
                    complete: () &#x3D;&gt; {
                        this.#messageService.add({ severity: &#x27;info&#x27;, summary: &#x27;Confirmed&#x27;, detail: &#x27;Authorization revoked for &#x27; + member.fullName })
                        this.project.reload()
                    }
                }),
            reject: () &#x3D;&gt; {}
        });
    }
    

    confirmMemberRemoval(event: Event, member: ProjectMember) {
        this.#confirmationService.confirm({
            key: &#x27;remove&#x27;,
            header: &#x27;Danger Zone&#x27;,
            message: &#x27;Do you want to remove &#x27; + member.fullName + &#x27; from the project?&#x27;,
            icon: &#x27;pi pi-info-circle&#x27;,
            rejectButtonProps: {
                label: &#x27;Cancel&#x27;,
                severity: &#x27;secondary&#x27;,
                outlined: true
            },
            acceptButtonProps: {
                label: &#x27;Delete&#x27;,
                severity: &#x27;danger&#x27;
            },
            accept: () &#x3D;&gt; {
                const members &#x3D; this.project.value()?.members?.filter(m &#x3D;&gt; m !&#x3D;&#x3D; member.username) || []
                this.updateProjectMembers(members)
            },
        });
    }

    addMember(member: string) {
        this.updateProjectMembers([...(this.project.value()?.members || []), member])
    }

    private updateProjectMembers(members: string[]) {
        const payload &#x3D; {
                leader: this.project.value()?.leader,
                status: this.project.value()?.status,
                title: this.project.value()?.title,
                summary: this.project.value()?.description,
                clinicalCenters: this.project.value()?.clinicalCenters,
                ethicsApprovalNumber: this.project.value()?.ethicsApprovalNumber,
                members: members
            } as ProjectCreate
        this.#projectsService.updateProjectById({
            projectId: this.projectId(),
            projectCreate: payload
        }).subscribe({
            complete: () &#x3D;&gt; {
                this.#messageService.add({ severity: &#x27;success&#x27;, summary: &#x27;Project update&#x27;, detail: &#x27;Successfully updated project members.&#x27; })
                this.project.reload()
            }
        })
    }

}</code></pre>
    </div>
</div>








                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'interface';
            var COMPODOC_CURRENT_PAGE_URL = 'ProjectMember.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script>
               $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               checkToggle(darkModeState);
               if ($darkModeToggleSwitchers.length > 0) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].addEventListener('change', function (event) {
                              darkModeState = !darkModeState;
                              toggleDarkMode(darkModeState);
                         });
                    }
               }
          </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
